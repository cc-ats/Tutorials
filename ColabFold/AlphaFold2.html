

<!DOCTYPE html>


<html lang="en" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.19: https://docutils.sourceforge.io/" />

    <title>News &#8212; Tutorials</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=e353d410970836974a52" rel="stylesheet" />
<link href="../_static/styles/bootstrap.css?digest=e353d410970836974a52" rel="stylesheet" />
<link href="../_static/styles/pydata-sphinx-theme.css?digest=e353d410970836974a52" rel="stylesheet" />

  
  <link href="../_static/vendor/fontawesome/6.1.2/css/all.min.css?digest=e353d410970836974a52" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.1.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.1.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.1.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" href="../_static/styles/sphinx-book-theme.css?digest=14f4ca6b54d191a8c7657f6c759bf11a5fb86285" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../_static/design-style.4045f2051d55cab465a707391d5b2007.min.css" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/bootstrap.js?digest=e353d410970836974a52" />
<link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=e353d410970836974a52" />

    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/sphinx_highlight.js"></script>
    <script src="../_static/clipboard.min.js"></script>
    <script src="../_static/copybutton.js"></script>
    <script src="../_static/scripts/sphinx-book-theme.js?digest=5a5c038af52cf7bc1a1ec88eea08e6366ee68824"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../_static/togglebutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../_static/design-tabs.js"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="../_static/sphinx-thebe.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'ColabFold/AlphaFold2';</script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="prev" title="Tutorials" href="../index.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <a class="skip-link" href="#main-content">Skip to main content</a>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__primary"
          id="__primary"/>
  <label class="overlay overlay-primary" for="__primary"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__secondary"
          id="__secondary"/>
  <label class="overlay overlay-secondary" for="__secondary"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>
  
    <nav class="bd-header navbar navbar-expand-lg bd-navbar">
    </nav>
  
  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">
  

<a class="navbar-brand logo" href="../index.html">
  
  
  
  
    
    
      
    
    
    <img src="../_static/schrodinger_cat_white_bbg.png" class="logo__image only-light" alt="Logo image"/>
    <script>document.write(`<img src="../_static/schrodinger_cat_white_bbg.png" class="logo__image only-dark" alt="Logo image"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item"><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../index.html">
                    Tutorials
                </a>
            </li>
        </ul>
        <ul class="current nav bd-sidenav">
<li class="toctree-l1 current active"><a class="current reference internal" href="#">News</a></li>

</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><label class="sidebar-toggle primary-toggle btn btn-sm" for="__primary" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</label></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-launch-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Launch interactive content">
    <i class="fas fa-rocket"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://colab.research.google.com/github/cc-ats/Tutorials/blob/master/./ColabFold/AlphaFold2.ipynb" target="_blank"
   class="btn btn-sm dropdown-item"
   title="Launch onColab"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  
    <img src="../_static/images/logo_colab.png">
  </span>
<span class="btn__text-container">Colab</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/cc-ats/Tutorials" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/cc-ats/Tutorials/issues/new?title=Issue%20on%20page%20%2FColabFold/AlphaFold2.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../_sources/ColabFold/AlphaFold2.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>


<script>
document.write(`
  <button class="theme-switch-button btn btn-sm btn-outline-primary navbar-btn rounded-circle" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch" data-mode="light"><i class="fa-solid fa-sun"></i></span>
    <span class="theme-switch" data-mode="dark"><i class="fa-solid fa-moon"></i></span>
    <span class="theme-switch" data-mode="auto"><i class="fa-solid fa-circle-half-stroke"></i></span>
  </button>
`);
</script>

<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
  </button>
`);
</script>
<label class="sidebar-toggle secondary-toggle btn btn-sm" for="__secondary"title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</label>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>News</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#">News</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#instructions-a-name-instructions-a">Instructions <a name="Instructions"></a></a></li>
</ul>

            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article" role="main">
                  
  <p><a href="https://colab.research.google.com/github/cc-ats/Tutorials/blob/main/ColabFold/AlphaFold2.ipynb" target="_parent"><img alt="Open In Colab" src="https://colab.research.google.com/assets/colab-badge.svg" /></a></p>
<a class="reference internal image-reference" href="https://raw.githubusercontent.com/sokrypton/ColabFold/main/.github/ColabFold_Marv_Logo_Small.png"><img alt="https://raw.githubusercontent.com/sokrypton/ColabFold/main/.github/ColabFold_Marv_Logo_Small.png" class="align-right" src="https://raw.githubusercontent.com/sokrypton/ColabFold/main/.github/ColabFold_Marv_Logo_Small.png" style="height: 200px;" /></a>
<p>##ColabFold v1.5.3: AlphaFold2 using MMseqs2</p>
<p>Easy to use protein structure and complex prediction using <a class="reference external" href="https://www.nature.com/articles/s41586-021-03819-2">AlphaFold2</a> and <a class="reference external" href="https://www.biorxiv.org/content/10.1101/2021.10.04.463034v1">Alphafold2-multimer</a>. Sequence alignments/templates are generated through <span class="xref myst">MMseqs2</span> and <a class="reference external" href="https://github.com/soedinglab/hh-suite">HHsearch</a>. For more details, see <a href="#Instructions">bottom</a> of the notebook, checkout the <a class="reference external" href="https://github.com/sokrypton/ColabFold">ColabFold GitHub</a> and read our manuscript.
Old versions: <a class="reference external" href="https://colab.research.google.com/github/sokrypton/ColabFold/blob/v1.4.0/AlphaFold2.ipynb">v1.4</a>, <a class="reference external" href="https://colab.research.google.com/github/sokrypton/ColabFold/blob/v1.5.1/AlphaFold2.ipynb">v1.5.1</a>, <a class="reference external" href="https://colab.research.google.com/github/sokrypton/ColabFold/blob/v1.5.2/AlphaFold2.ipynb">v1.5.2</a></p>
<p><a class="reference external" href="https://www.nature.com/articles/s41592-022-01488-1">Mirdita M, Schütze K, Moriwaki Y, Heo L, Ovchinnikov S, Steinegger M. ColabFold: Making protein folding accessible to all.
<em>Nature Methods</em>, 2022</a></p>
<hr class="docutils" />
<section id="news">
<h1>News<a class="headerlink" href="#news" title="Permalink to this heading">#</a></h1>
<ul class="simple">
<li><p><b><font color='green'>2023/07/31: The ColabFold MSA server is back to normal. It was using older DB (UniRef30 2202/PDB70 220313) from 27th ~8:30 AM CEST to 31st ~11:10 AM CEST.</font></b></p></li>
<li><p><b><font color='green'>2023/06/12: New databases! UniRef30 updated to 2023_02 and PDB to 230517. We now use PDB100 instead of PDB70 (see <span class="xref myst">notes</span>).</font></b></p></li>
<li><p><b><font color='green'>2023/06/12: We introduced a new default pairing strategy: Previously, for multimer predictions with more than 2 chains, we only pair if all sequences taxonomically match (“complete” pairing). The new default “greedy” strategy pairs any taxonomically matching subsets.</font></b></p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># @title Input protein sequence(s), then hit `Runtime` -&gt; `Run all` { display-mode: &quot;form&quot; }</span>
<span class="kn">from</span> <span class="nn">google.colab</span> <span class="kn">import</span> <span class="n">files</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">hashlib</span>
<span class="kn">import</span> <span class="nn">random</span>

<span class="kn">from</span> <span class="nn">sys</span> <span class="kn">import</span> <span class="n">version_info</span>
<span class="n">python_version</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">version_info</span><span class="o">.</span><span class="n">major</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">version_info</span><span class="o">.</span><span class="n">minor</span><span class="si">}</span><span class="s2">&quot;</span>

<span class="k">def</span> <span class="nf">add_hash</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">):</span>
  <span class="k">return</span> <span class="n">x</span><span class="o">+</span><span class="s2">&quot;_&quot;</span><span class="o">+</span><span class="n">hashlib</span><span class="o">.</span><span class="n">sha1</span><span class="p">(</span><span class="n">y</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()[:</span><span class="mi">5</span><span class="p">]</span>

<span class="n">query_sequence</span> <span class="o">=</span> <span class="s1">&#39;PIAQIHILEGRSDEQKETLIREVSEAISRSLDAPLTSVRVIITEMAKGHFGIGGELASK&#39;</span> <span class="c1">#@param {type:&quot;string&quot;}</span>
<span class="c1">#@markdown  - Use `:` to specify inter-protein chainbreaks for **modeling complexes** (supports homo- and hetro-oligomers). For example **PI...SK:PI...SK** for a homodimer</span>
<span class="n">jobname</span> <span class="o">=</span> <span class="s1">&#39;test&#39;</span> <span class="c1">#@param {type:&quot;string&quot;}</span>
<span class="c1"># number of models to use</span>
<span class="n">num_relax</span> <span class="o">=</span> <span class="mi">0</span> <span class="c1">#@param [0, 1, 5] {type:&quot;raw&quot;}</span>
<span class="c1">#@markdown - specify how many of the top ranked structures to relax using amber</span>
<span class="n">template_mode</span> <span class="o">=</span> <span class="s2">&quot;none&quot;</span> <span class="c1">#@param [&quot;none&quot;, &quot;pdb100&quot;,&quot;custom&quot;]</span>
<span class="c1">#@markdown - `none` = no template information is used. `pdb100` = detect templates in pdb100 (see [notes](#pdb100)). `custom` - upload and search own templates (PDB or mmCIF format, see [notes](#custom_templates))</span>

<span class="n">use_amber</span> <span class="o">=</span> <span class="n">num_relax</span> <span class="o">&gt;</span> <span class="mi">0</span>

<span class="c1"># remove whitespaces</span>
<span class="n">query_sequence</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">query_sequence</span><span class="o">.</span><span class="n">split</span><span class="p">())</span>

<span class="n">basejobname</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">jobname</span><span class="o">.</span><span class="n">split</span><span class="p">())</span>
<span class="n">basejobname</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\W+&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">basejobname</span><span class="p">)</span>
<span class="n">jobname</span> <span class="o">=</span> <span class="n">add_hash</span><span class="p">(</span><span class="n">basejobname</span><span class="p">,</span> <span class="n">query_sequence</span><span class="p">)</span>

<span class="c1"># check if directory with jobname exists</span>
<span class="k">def</span> <span class="nf">check</span><span class="p">(</span><span class="n">folder</span><span class="p">):</span>
  <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">folder</span><span class="p">):</span>
    <span class="k">return</span> <span class="kc">False</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="k">return</span> <span class="kc">True</span>
<span class="k">if</span> <span class="ow">not</span> <span class="n">check</span><span class="p">(</span><span class="n">jobname</span><span class="p">):</span>
  <span class="n">n</span> <span class="o">=</span> <span class="mi">0</span>
  <span class="k">while</span> <span class="ow">not</span> <span class="n">check</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">jobname</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">n</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">):</span> <span class="n">n</span> <span class="o">+=</span> <span class="mi">1</span>
  <span class="n">jobname</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">jobname</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">n</span><span class="si">}</span><span class="s2">&quot;</span>

<span class="c1"># make directory to save results</span>
<span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">jobname</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="c1"># save queries</span>
<span class="n">queries_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">jobname</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">jobname</span><span class="si">}</span><span class="s2">.csv&quot;</span><span class="p">)</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">queries_path</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">text_file</span><span class="p">:</span>
  <span class="n">text_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;id,sequence</span><span class="se">\n</span><span class="si">{</span><span class="n">jobname</span><span class="si">}</span><span class="s2">,</span><span class="si">{</span><span class="n">query_sequence</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="k">if</span> <span class="n">template_mode</span> <span class="o">==</span> <span class="s2">&quot;pdb100&quot;</span><span class="p">:</span>
  <span class="n">use_templates</span> <span class="o">=</span> <span class="kc">True</span>
  <span class="n">custom_template_path</span> <span class="o">=</span> <span class="kc">None</span>
<span class="k">elif</span> <span class="n">template_mode</span> <span class="o">==</span> <span class="s2">&quot;custom&quot;</span><span class="p">:</span>
  <span class="n">custom_template_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">jobname</span><span class="p">,</span><span class="sa">f</span><span class="s2">&quot;template&quot;</span><span class="p">)</span>
  <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">custom_template_path</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
  <span class="n">uploaded</span> <span class="o">=</span> <span class="n">files</span><span class="o">.</span><span class="n">upload</span><span class="p">()</span>
  <span class="n">use_templates</span> <span class="o">=</span> <span class="kc">True</span>
  <span class="k">for</span> <span class="n">fn</span> <span class="ow">in</span> <span class="n">uploaded</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
    <span class="n">os</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">custom_template_path</span><span class="p">,</span><span class="n">fn</span><span class="p">))</span>
<span class="k">else</span><span class="p">:</span>
  <span class="n">custom_template_path</span> <span class="o">=</span> <span class="kc">None</span>
  <span class="n">use_templates</span> <span class="o">=</span> <span class="kc">False</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;jobname&quot;</span><span class="p">,</span><span class="n">jobname</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;sequence&quot;</span><span class="p">,</span><span class="n">query_sequence</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;length&quot;</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">query_sequence</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">,</span><span class="s2">&quot;&quot;</span><span class="p">)))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>jobname test_a5e17
sequence PIAQIHILEGRSDEQKETLIREVSEAISRSLDAPLTSVRVIITEMAKGHFGIGGELASK
length 59
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># @title Install dependencies { display-mode: &quot;form&quot; }</span>
<span class="o">%%time</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="n">USE_AMBER</span> <span class="o">=</span> <span class="n">use_amber</span>
<span class="n">USE_TEMPLATES</span> <span class="o">=</span> <span class="n">use_templates</span>
<span class="n">PYTHON_VERSION</span> <span class="o">=</span> <span class="n">python_version</span>

<span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="s2">&quot;COLABFOLD_READY&quot;</span><span class="p">):</span>
  <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;installing colabfold...&quot;</span><span class="p">)</span>
  <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s2">&quot;pip install -q --no-warn-conflicts &#39;colabfold[alphafold-minus-jax] @ git+https://github.com/sokrypton/ColabFold&#39;&quot;</span><span class="p">)</span>
  <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s2">&quot;pip install --upgrade dm-haiku&quot;</span><span class="p">)</span>
  <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s2">&quot;ln -s /usr/local/lib/python3.*/dist-packages/colabfold colabfold&quot;</span><span class="p">)</span>
  <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s2">&quot;ln -s /usr/local/lib/python3.*/dist-packages/alphafold alphafold&quot;</span><span class="p">)</span>
  <span class="c1"># patch for jax &gt; 0.3.25</span>
  <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s2">&quot;sed -i &#39;s/weights = jax.nn.softmax(logits)/logits=jnp.clip(logits,-1e8,1e8);weights=jax.nn.softmax(logits)/g&#39; alphafold/model/modules.py&quot;</span><span class="p">)</span>
  <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s2">&quot;touch COLABFOLD_READY&quot;</span><span class="p">)</span>

<span class="k">if</span> <span class="n">USE_AMBER</span> <span class="ow">or</span> <span class="n">USE_TEMPLATES</span><span class="p">:</span>
  <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="s2">&quot;CONDA_READY&quot;</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;installing conda...&quot;</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s2">&quot;wget -qnc https://github.com/conda-forge/miniforge/releases/latest/download/Mambaforge-Linux-x86_64.sh&quot;</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s2">&quot;bash Mambaforge-Linux-x86_64.sh -bfp /usr/local&quot;</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s2">&quot;mamba config --set auto_update_conda false&quot;</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s2">&quot;touch CONDA_READY&quot;</span><span class="p">)</span>

<span class="k">if</span> <span class="n">USE_TEMPLATES</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="s2">&quot;HH_READY&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">USE_AMBER</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="s2">&quot;AMBER_READY&quot;</span><span class="p">):</span>
  <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;installing hhsuite and amber...&quot;</span><span class="p">)</span>
  <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;mamba install -y -c conda-forge -c bioconda kalign2=2.04 hhsuite=3.3.0 openmm=7.7.0 python=&#39;</span><span class="si">{</span><span class="n">PYTHON_VERSION</span><span class="si">}</span><span class="s2">&#39; pdbfixer&quot;</span><span class="p">)</span>
  <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s2">&quot;touch HH_READY&quot;</span><span class="p">)</span>
  <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s2">&quot;touch AMBER_READY&quot;</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
  <span class="k">if</span> <span class="n">USE_TEMPLATES</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="s2">&quot;HH_READY&quot;</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;installing hhsuite...&quot;</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;mamba install -y -c conda-forge -c bioconda kalign2=2.04 hhsuite=3.3.0 python=&#39;</span><span class="si">{</span><span class="n">PYTHON_VERSION</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s2">&quot;touch HH_READY&quot;</span><span class="p">)</span>
  <span class="k">if</span> <span class="n">USE_AMBER</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="s2">&quot;AMBER_READY&quot;</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;installing amber...&quot;</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;mamba install -y -c conda-forge openmm=7.7.0 python=&#39;</span><span class="si">{</span><span class="n">PYTHON_VERSION</span><span class="si">}</span><span class="s2">&#39; pdbfixer&quot;</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s2">&quot;touch AMBER_READY&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>installing colabfold...
CPU times: user 114 ms, sys: 27.2 ms, total: 142 ms
Wall time: 42.9 s
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#@markdown ### MSA options (custom MSA upload, single sequence, pairing mode)</span>
<span class="n">msa_mode</span> <span class="o">=</span> <span class="s2">&quot;mmseqs2_uniref_env&quot;</span> <span class="c1">#@param [&quot;mmseqs2_uniref_env&quot;, &quot;mmseqs2_uniref&quot;,&quot;single_sequence&quot;,&quot;custom&quot;]</span>
<span class="n">pair_mode</span> <span class="o">=</span> <span class="s2">&quot;unpaired_paired&quot;</span> <span class="c1">#@param [&quot;unpaired_paired&quot;,&quot;paired&quot;,&quot;unpaired&quot;] {type:&quot;string&quot;}</span>
<span class="c1">#@markdown - &quot;unpaired_paired&quot; = pair sequences from same species + unpaired MSA, &quot;unpaired&quot; = seperate MSA for each chain, &quot;paired&quot; - only use paired sequences.</span>

<span class="c1"># decide which a3m to use</span>
<span class="k">if</span> <span class="s2">&quot;mmseqs2&quot;</span> <span class="ow">in</span> <span class="n">msa_mode</span><span class="p">:</span>
  <span class="n">a3m_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">jobname</span><span class="p">,</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">jobname</span><span class="si">}</span><span class="s2">.a3m&quot;</span><span class="p">)</span>

<span class="k">elif</span> <span class="n">msa_mode</span> <span class="o">==</span> <span class="s2">&quot;custom&quot;</span><span class="p">:</span>
  <span class="n">a3m_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">jobname</span><span class="p">,</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">jobname</span><span class="si">}</span><span class="s2">.custom.a3m&quot;</span><span class="p">)</span>
  <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">a3m_file</span><span class="p">):</span>
    <span class="n">custom_msa_dict</span> <span class="o">=</span> <span class="n">files</span><span class="o">.</span><span class="n">upload</span><span class="p">()</span>
    <span class="n">custom_msa</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">custom_msa_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">header</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="kn">import</span> <span class="nn">fileinput</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">fileinput</span><span class="o">.</span><span class="n">FileInput</span><span class="p">(</span><span class="n">custom_msa</span><span class="p">,</span><span class="n">inplace</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
      <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;&gt;&quot;</span><span class="p">):</span>
         <span class="n">header</span> <span class="o">=</span> <span class="n">header</span> <span class="o">+</span> <span class="mi">1</span>
      <span class="k">if</span> <span class="ow">not</span> <span class="n">line</span><span class="o">.</span><span class="n">rstrip</span><span class="p">():</span>
        <span class="k">continue</span>
      <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;&gt;&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="kc">False</span> <span class="ow">and</span> <span class="n">header</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
         <span class="n">query_sequence</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">rstrip</span><span class="p">()</span>
      <span class="nb">print</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>

    <span class="n">os</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">custom_msa</span><span class="p">,</span> <span class="n">a3m_file</span><span class="p">)</span>
    <span class="n">queries_path</span><span class="o">=</span><span class="n">a3m_file</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;moving </span><span class="si">{</span><span class="n">custom_msa</span><span class="si">}</span><span class="s2"> to </span><span class="si">{</span><span class="n">a3m_file</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="k">else</span><span class="p">:</span>
  <span class="n">a3m_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">jobname</span><span class="p">,</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">jobname</span><span class="si">}</span><span class="s2">.single_sequence.a3m&quot;</span><span class="p">)</span>
  <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">a3m_file</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">text_file</span><span class="p">:</span>
    <span class="n">text_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;&gt;1</span><span class="se">\n</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">query_sequence</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># @title  { display-mode: &quot;form&quot; }</span>
<span class="c1">#@markdown ### Advanced settings</span>
<span class="n">model_type</span> <span class="o">=</span> <span class="s2">&quot;auto&quot;</span> <span class="c1">#@param [&quot;auto&quot;, &quot;alphafold2_ptm&quot;, &quot;alphafold2_multimer_v1&quot;, &quot;alphafold2_multimer_v2&quot;, &quot;alphafold2_multimer_v3&quot;]</span>
<span class="c1">#@markdown - if `auto` selected, will use `alphafold2_ptm` for monomer prediction and `alphafold2_multimer_v3` for complex prediction.</span>
<span class="c1">#@markdown Any of the mode_types can be used (regardless if input is monomer or complex).</span>
<span class="n">num_recycles</span> <span class="o">=</span> <span class="s2">&quot;3&quot;</span> <span class="c1">#@param [&quot;auto&quot;, &quot;0&quot;, &quot;1&quot;, &quot;3&quot;, &quot;6&quot;, &quot;12&quot;, &quot;24&quot;, &quot;48&quot;]</span>
<span class="c1">#@markdown - if `auto` selected, will use `num_recycles=20` if `model_type=alphafold2_multimer_v3`, else `num_recycles=3` .</span>
<span class="n">recycle_early_stop_tolerance</span> <span class="o">=</span> <span class="s2">&quot;auto&quot;</span> <span class="c1">#@param [&quot;auto&quot;, &quot;0.0&quot;, &quot;0.5&quot;, &quot;1.0&quot;]</span>
<span class="c1">#@markdown - if `auto` selected, will use `tol=0.5` if `model_type=alphafold2_multimer_v3` else `tol=0.0`.</span>
<span class="n">relax_max_iterations</span> <span class="o">=</span> <span class="mi">200</span> <span class="c1">#@param [0, 200, 2000] {type:&quot;raw&quot;}</span>
<span class="c1">#@markdown - max amber relax iterations, `0` = unlimited (AlphaFold2 default, can take very long)</span>
<span class="n">pairing_strategy</span> <span class="o">=</span> <span class="s2">&quot;greedy&quot;</span> <span class="c1">#@param [&quot;greedy&quot;, &quot;complete&quot;] {type:&quot;string&quot;}</span>
<span class="c1">#@markdown - `greedy` = pair any taxonomically matching subsets, `complete` = all sequences have to match in one line.</span>


<span class="c1">#@markdown #### Sample settings</span>
<span class="c1">#@markdown -  enable dropouts and increase number of seeds to sample predictions from uncertainty of the model.</span>
<span class="c1">#@markdown -  decrease `max_msa` to increase uncertainity</span>
<span class="n">max_msa</span> <span class="o">=</span> <span class="s2">&quot;auto&quot;</span> <span class="c1">#@param [&quot;auto&quot;, &quot;512:1024&quot;, &quot;256:512&quot;, &quot;64:128&quot;, &quot;32:64&quot;, &quot;16:32&quot;]</span>
<span class="n">num_seeds</span> <span class="o">=</span> <span class="mi">1</span> <span class="c1">#@param [1,2,4,8,16] {type:&quot;raw&quot;}</span>
<span class="n">use_dropout</span> <span class="o">=</span> <span class="kc">False</span> <span class="c1">#@param {type:&quot;boolean&quot;}</span>

<span class="n">num_recycles</span> <span class="o">=</span> <span class="kc">None</span> <span class="k">if</span> <span class="n">num_recycles</span> <span class="o">==</span> <span class="s2">&quot;auto&quot;</span> <span class="k">else</span> <span class="nb">int</span><span class="p">(</span><span class="n">num_recycles</span><span class="p">)</span>
<span class="n">recycle_early_stop_tolerance</span> <span class="o">=</span> <span class="kc">None</span> <span class="k">if</span> <span class="n">recycle_early_stop_tolerance</span> <span class="o">==</span> <span class="s2">&quot;auto&quot;</span> <span class="k">else</span> <span class="nb">float</span><span class="p">(</span><span class="n">recycle_early_stop_tolerance</span><span class="p">)</span>
<span class="k">if</span> <span class="n">max_msa</span> <span class="o">==</span> <span class="s2">&quot;auto&quot;</span><span class="p">:</span> <span class="n">max_msa</span> <span class="o">=</span> <span class="kc">None</span>

<span class="c1">#@markdown #### Save settings</span>
<span class="n">save_all</span> <span class="o">=</span> <span class="kc">False</span> <span class="c1">#@param {type:&quot;boolean&quot;}</span>
<span class="n">save_recycles</span> <span class="o">=</span> <span class="kc">False</span> <span class="c1">#@param {type:&quot;boolean&quot;}</span>
<span class="n">save_to_google_drive</span> <span class="o">=</span> <span class="kc">False</span> <span class="c1">#@param {type:&quot;boolean&quot;}</span>
<span class="c1">#@markdown -  if the save_to_google_drive option was selected, the result zip will be uploaded to your Google Drive</span>
<span class="n">dpi</span> <span class="o">=</span> <span class="mi">200</span> <span class="c1">#@param {type:&quot;integer&quot;}</span>
<span class="c1">#@markdown - set dpi for image resolution</span>

<span class="k">if</span> <span class="n">save_to_google_drive</span><span class="p">:</span>
  <span class="kn">from</span> <span class="nn">pydrive.drive</span> <span class="kn">import</span> <span class="n">GoogleDrive</span>
  <span class="kn">from</span> <span class="nn">pydrive.auth</span> <span class="kn">import</span> <span class="n">GoogleAuth</span>
  <span class="kn">from</span> <span class="nn">google.colab</span> <span class="kn">import</span> <span class="n">auth</span>
  <span class="kn">from</span> <span class="nn">oauth2client.client</span> <span class="kn">import</span> <span class="n">GoogleCredentials</span>
  <span class="n">auth</span><span class="o">.</span><span class="n">authenticate_user</span><span class="p">()</span>
  <span class="n">gauth</span> <span class="o">=</span> <span class="n">GoogleAuth</span><span class="p">()</span>
  <span class="n">gauth</span><span class="o">.</span><span class="n">credentials</span> <span class="o">=</span> <span class="n">GoogleCredentials</span><span class="o">.</span><span class="n">get_application_default</span><span class="p">()</span>
  <span class="n">drive</span> <span class="o">=</span> <span class="n">GoogleDrive</span><span class="p">(</span><span class="n">gauth</span><span class="p">)</span>
  <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;You are logged into Google Drive and are good to go!&quot;</span><span class="p">)</span>

<span class="c1">#@markdown Don&#39;t forget to hit `Runtime` -&gt; `Run all` after updating the form.</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#@title Run Prediction</span>
<span class="n">display_images</span> <span class="o">=</span> <span class="kc">True</span> <span class="c1">#@param {type:&quot;boolean&quot;}</span>

<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span><span class="p">(</span><span class="n">action</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="ne">FutureWarning</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">Bio</span> <span class="kn">import</span> <span class="n">BiopythonDeprecationWarning</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span><span class="p">(</span><span class="n">action</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="n">BiopythonDeprecationWarning</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span> <span class="nn">colabfold.download</span> <span class="kn">import</span> <span class="n">download_alphafold_params</span><span class="p">,</span> <span class="n">default_data_dir</span>
<span class="kn">from</span> <span class="nn">colabfold.utils</span> <span class="kn">import</span> <span class="n">setup_logging</span>
<span class="kn">from</span> <span class="nn">colabfold.batch</span> <span class="kn">import</span> <span class="n">get_queries</span><span class="p">,</span> <span class="n">run</span><span class="p">,</span> <span class="n">set_model_type</span>
<span class="kn">from</span> <span class="nn">colabfold.plot</span> <span class="kn">import</span> <span class="n">plot_msa_v2</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="k">try</span><span class="p">:</span>
  <span class="n">K80_chk</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">popen</span><span class="p">(</span><span class="s1">&#39;nvidia-smi | grep &quot;Tesla K80&quot; | wc -l&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
<span class="k">except</span><span class="p">:</span>
  <span class="n">K80_chk</span> <span class="o">=</span> <span class="s2">&quot;0&quot;</span>
  <span class="k">pass</span>
<span class="k">if</span> <span class="s2">&quot;1&quot;</span> <span class="ow">in</span> <span class="n">K80_chk</span><span class="p">:</span>
  <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;WARNING: found GPU Tesla K80: limited to total length &lt; 1000&quot;</span><span class="p">)</span>
  <span class="k">if</span> <span class="s2">&quot;TF_FORCE_UNIFIED_MEMORY&quot;</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">:</span>
    <span class="k">del</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;TF_FORCE_UNIFIED_MEMORY&quot;</span><span class="p">]</span>
  <span class="k">if</span> <span class="s2">&quot;XLA_PYTHON_CLIENT_MEM_FRACTION&quot;</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">:</span>
    <span class="k">del</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;XLA_PYTHON_CLIENT_MEM_FRACTION&quot;</span><span class="p">]</span>

<span class="kn">from</span> <span class="nn">colabfold.colabfold</span> <span class="kn">import</span> <span class="n">plot_protein</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>

<span class="c1"># For some reason we need that to get pdbfixer to import</span>
<span class="k">if</span> <span class="n">use_amber</span> <span class="ow">and</span> <span class="sa">f</span><span class="s2">&quot;/usr/local/lib/python</span><span class="si">{</span><span class="n">python_version</span><span class="si">}</span><span class="s2">/site-packages/&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="p">:</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;/usr/local/lib/python</span><span class="si">{</span><span class="n">python_version</span><span class="si">}</span><span class="s2">/site-packages/&quot;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">input_features_callback</span><span class="p">(</span><span class="n">input_features</span><span class="p">):</span>
  <span class="k">if</span> <span class="n">display_images</span><span class="p">:</span>
    <span class="n">plot_msa_v2</span><span class="p">(</span><span class="n">input_features</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">prediction_callback</span><span class="p">(</span><span class="n">protein_obj</span><span class="p">,</span> <span class="n">length</span><span class="p">,</span>
                        <span class="n">prediction_result</span><span class="p">,</span> <span class="n">input_features</span><span class="p">,</span> <span class="n">mode</span><span class="p">):</span>
  <span class="n">model_name</span><span class="p">,</span> <span class="n">relaxed</span> <span class="o">=</span> <span class="n">mode</span>
  <span class="k">if</span> <span class="ow">not</span> <span class="n">relaxed</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">display_images</span><span class="p">:</span>
      <span class="n">fig</span> <span class="o">=</span> <span class="n">plot_protein</span><span class="p">(</span><span class="n">protein_obj</span><span class="p">,</span> <span class="n">Ls</span><span class="o">=</span><span class="n">length</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">150</span><span class="p">)</span>
      <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
      <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

<span class="n">result_dir</span> <span class="o">=</span> <span class="n">jobname</span>
<span class="n">log_filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">jobname</span><span class="p">,</span><span class="s2">&quot;log.txt&quot;</span><span class="p">)</span>
<span class="n">setup_logging</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="n">log_filename</span><span class="p">))</span>

<span class="n">queries</span><span class="p">,</span> <span class="n">is_complex</span> <span class="o">=</span> <span class="n">get_queries</span><span class="p">(</span><span class="n">queries_path</span><span class="p">)</span>
<span class="n">model_type</span> <span class="o">=</span> <span class="n">set_model_type</span><span class="p">(</span><span class="n">is_complex</span><span class="p">,</span> <span class="n">model_type</span><span class="p">)</span>

<span class="k">if</span> <span class="s2">&quot;multimer&quot;</span> <span class="ow">in</span> <span class="n">model_type</span> <span class="ow">and</span> <span class="n">max_msa</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
  <span class="n">use_cluster_profile</span> <span class="o">=</span> <span class="kc">False</span>
<span class="k">else</span><span class="p">:</span>
  <span class="n">use_cluster_profile</span> <span class="o">=</span> <span class="kc">True</span>

<span class="n">download_alphafold_params</span><span class="p">(</span><span class="n">model_type</span><span class="p">,</span> <span class="n">Path</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">))</span>
<span class="n">results</span> <span class="o">=</span> <span class="n">run</span><span class="p">(</span>
    <span class="n">queries</span><span class="o">=</span><span class="n">queries</span><span class="p">,</span>
    <span class="n">result_dir</span><span class="o">=</span><span class="n">result_dir</span><span class="p">,</span>
    <span class="n">use_templates</span><span class="o">=</span><span class="n">use_templates</span><span class="p">,</span>
    <span class="n">custom_template_path</span><span class="o">=</span><span class="n">custom_template_path</span><span class="p">,</span>
    <span class="n">num_relax</span><span class="o">=</span><span class="n">num_relax</span><span class="p">,</span>
    <span class="n">msa_mode</span><span class="o">=</span><span class="n">msa_mode</span><span class="p">,</span>
    <span class="n">model_type</span><span class="o">=</span><span class="n">model_type</span><span class="p">,</span>
    <span class="n">num_models</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
    <span class="n">num_recycles</span><span class="o">=</span><span class="n">num_recycles</span><span class="p">,</span>
    <span class="n">relax_max_iterations</span><span class="o">=</span><span class="n">relax_max_iterations</span><span class="p">,</span>
    <span class="n">recycle_early_stop_tolerance</span><span class="o">=</span><span class="n">recycle_early_stop_tolerance</span><span class="p">,</span>
    <span class="n">num_seeds</span><span class="o">=</span><span class="n">num_seeds</span><span class="p">,</span>
    <span class="n">use_dropout</span><span class="o">=</span><span class="n">use_dropout</span><span class="p">,</span>
    <span class="n">model_order</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">],</span>
    <span class="n">is_complex</span><span class="o">=</span><span class="n">is_complex</span><span class="p">,</span>
    <span class="n">data_dir</span><span class="o">=</span><span class="n">Path</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">),</span>
    <span class="n">keep_existing_results</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">rank_by</span><span class="o">=</span><span class="s2">&quot;auto&quot;</span><span class="p">,</span>
    <span class="n">pair_mode</span><span class="o">=</span><span class="n">pair_mode</span><span class="p">,</span>
    <span class="n">pairing_strategy</span><span class="o">=</span><span class="n">pairing_strategy</span><span class="p">,</span>
    <span class="n">stop_at_score</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="mi">100</span><span class="p">),</span>
    <span class="n">prediction_callback</span><span class="o">=</span><span class="n">prediction_callback</span><span class="p">,</span>
    <span class="n">dpi</span><span class="o">=</span><span class="n">dpi</span><span class="p">,</span>
    <span class="n">zip_results</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">save_all</span><span class="o">=</span><span class="n">save_all</span><span class="p">,</span>
    <span class="n">max_msa</span><span class="o">=</span><span class="n">max_msa</span><span class="p">,</span>
    <span class="n">use_cluster_profile</span><span class="o">=</span><span class="n">use_cluster_profile</span><span class="p">,</span>
    <span class="n">input_features_callback</span><span class="o">=</span><span class="n">input_features_callback</span><span class="p">,</span>
    <span class="n">save_recycles</span><span class="o">=</span><span class="n">save_recycles</span><span class="p">,</span>
    <span class="n">user_agent</span><span class="o">=</span><span class="s2">&quot;colabfold/google-colab-main&quot;</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">results_zip</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">jobname</span><span class="si">}</span><span class="s2">.result.zip&quot;</span>
<span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;zip -r </span><span class="si">{</span><span class="n">results_zip</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">jobname</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Downloading alphafold2 weights to .: 100%|██████████| 3.47G/3.47G [02:40&lt;00:00, 23.2MB/s]
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2023-12-07 22:02:42,821 Unable to initialize backend &#39;rocm&#39;: NOT_FOUND: Could not find registered platform with name: &quot;rocm&quot;. Available platform names are: CUDA
2023-12-07 22:02:42,823 Unable to initialize backend &#39;tpu&#39;: INTERNAL: Failed to open libtpu.so: libtpu.so: cannot open shared object file: No such file or directory
2023-12-07 22:02:44,726 Running on GPU
2023-12-07 22:02:44,904 Found 4 citations for tools or databases
2023-12-07 22:02:44,904 Query 1/1: test_a5e17 (length 59)
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>COMPLETE: 100%|██████████| 150/150 [elapsed: 00:01 remaining: 00:00]
</pre></div>
</div>
<img alt="../_images/9994329806f45a5389c0debb2644aa89065e9c2ac09ed381afb2155d0ef75450.png" src="../_images/9994329806f45a5389c0debb2644aa89065e9c2ac09ed381afb2155d0ef75450.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2023-12-07 22:02:47,182 Setting max_seq=512, max_extra_seq=5120
</pre></div>
</div>
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">KeyboardInterrupt</span><span class="g g-Whitespace">                         </span>Traceback (most recent call last)
<span class="nn">&lt;ipython-input-5-06098a2c69e9&gt;</span> in <span class="ni">&lt;cell line: 65&gt;</span><span class="nt">()</span>
<span class="g g-Whitespace">     </span><span class="mi">63</span> 
<span class="g g-Whitespace">     </span><span class="mi">64</span> <span class="n">download_alphafold_params</span><span class="p">(</span><span class="n">model_type</span><span class="p">,</span> <span class="n">Path</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">))</span>
<span class="ne">---&gt; </span><span class="mi">65</span> <span class="n">results</span> <span class="o">=</span> <span class="n">run</span><span class="p">(</span>
<span class="g g-Whitespace">     </span><span class="mi">66</span>     <span class="n">queries</span><span class="o">=</span><span class="n">queries</span><span class="p">,</span>
<span class="g g-Whitespace">     </span><span class="mi">67</span>     <span class="n">result_dir</span><span class="o">=</span><span class="n">result_dir</span><span class="p">,</span>

<span class="nn">/content/colabfold/batch.py</span> in <span class="ni">run</span><span class="nt">(queries, result_dir, num_models, is_complex, num_recycles, recycle_early_stop_tolerance, model_order, num_ensemble, model_type, msa_mode, use_templates, custom_template_path, num_relax, relax_max_iterations, relax_tolerance, relax_stiffness, relax_max_outer_iterations, keep_existing_results, rank_by, pair_mode, pairing_strategy, data_dir, host_url, user_agent, random_seed, num_seeds, recompile_padding, zip_results, prediction_callback, save_single_representations, save_pair_representations, save_all, save_recycles, use_dropout, use_gpu_relax, stop_at_score, dpi, max_seq, max_extra_seq, pdb_hit_file, local_pdb_path, use_cluster_profile, feature_dict_callback, **kwargs)</span>
<span class="g g-Whitespace">   </span><span class="mi">1568</span>                     <span class="n">first_job</span> <span class="o">=</span> <span class="kc">False</span>
<span class="g g-Whitespace">   </span><span class="mi">1569</span> 
<span class="ne">-&gt; </span><span class="mi">1570</span>                 <span class="n">results</span> <span class="o">=</span> <span class="n">predict_structure</span><span class="p">(</span>
<span class="g g-Whitespace">   </span><span class="mi">1571</span>                     <span class="n">prefix</span><span class="o">=</span><span class="n">jobname</span><span class="p">,</span>
<span class="g g-Whitespace">   </span><span class="mi">1572</span>                     <span class="n">result_dir</span><span class="o">=</span><span class="n">result_dir</span><span class="p">,</span>

<span class="nn">/content/colabfold/batch.py</span> in <span class="ni">predict_structure</span><span class="nt">(prefix, result_dir, feature_dict, is_complex, use_templates, sequences_lengths, pad_len, model_type, model_runner_and_params, num_relax, relax_max_iterations, relax_tolerance, relax_stiffness, relax_max_outer_iterations, rank_by, random_seed, num_seeds, stop_at_score, prediction_callback, use_gpu_relax, save_all, save_single_representations, save_pair_representations, save_recycles)</span>
<span class="g g-Whitespace">    </span><span class="mi">419</span>             <span class="c1"># predict</span>
<span class="g g-Whitespace">    </span><span class="mi">420</span>             <span class="n">result</span><span class="p">,</span> <span class="n">recycles</span> <span class="o">=</span> \
<span class="ne">--&gt; </span><span class="mi">421</span>             <span class="n">model_runner</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">input_features</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">422</span>                 <span class="n">random_seed</span><span class="o">=</span><span class="n">seed</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">423</span>                 <span class="n">return_representations</span><span class="o">=</span><span class="n">return_representations</span><span class="p">,</span>

<span class="nn">/content/alphafold/model/model.py</span> in <span class="ni">predict</span><span class="nt">(self, feat, random_seed, return_representations, callback)</span>
<span class="g g-Whitespace">    </span><span class="mi">183</span>         <span class="c1"># run</span>
<span class="g g-Whitespace">    </span><span class="mi">184</span>         <span class="n">key</span><span class="p">,</span> <span class="n">sub_key</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
<span class="ne">--&gt; </span><span class="mi">185</span>         <span class="n">result</span><span class="p">,</span> <span class="n">prev</span> <span class="o">=</span> <span class="n">run</span><span class="p">(</span><span class="n">sub_key</span><span class="p">,</span> <span class="n">sub_feat</span><span class="p">,</span> <span class="n">prev</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">186</span> 
<span class="g g-Whitespace">    </span><span class="mi">187</span>         <span class="k">if</span> <span class="n">return_representations</span><span class="p">:</span>

<span class="nn">/content/alphafold/model/model.py</span> in <span class="ni">run</span><span class="nt">(key, feat, prev)</span>
<span class="g g-Whitespace">    </span><span class="mi">163</span>             <span class="n">x</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">v</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">float16</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">164</span>         <span class="k">return</span> <span class="n">x</span>
<span class="ne">--&gt; </span><span class="mi">165</span>       <span class="n">result</span> <span class="o">=</span> <span class="n">_jnp_to_np</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="p">{</span><span class="o">**</span><span class="n">feat</span><span class="p">,</span> <span class="s2">&quot;prev&quot;</span><span class="p">:</span><span class="n">prev</span><span class="p">}))</span>
<span class="g g-Whitespace">    </span><span class="mi">166</span>       <span class="n">prev</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;prev&quot;</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">167</span>       <span class="k">return</span> <span class="n">result</span><span class="p">,</span> <span class="n">prev</span>

    <span class="p">[</span><span class="o">...</span> <span class="n">skipping</span> <span class="n">hidden</span> <span class="mi">1</span> <span class="n">frame</span><span class="p">]</span>

<span class="nn">/usr/local/lib/python3.10/dist-packages/jax/_src/pjit.py</span> in <span class="ni">cache_miss</span><span class="nt">(*args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">254</span>   <span class="nd">@api_boundary</span>
<span class="g g-Whitespace">    </span><span class="mi">255</span>   <span class="k">def</span> <span class="nf">cache_miss</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="ne">--&gt; </span><span class="mi">256</span>     <span class="n">outs</span><span class="p">,</span> <span class="n">out_flat</span><span class="p">,</span> <span class="n">out_tree</span><span class="p">,</span> <span class="n">args_flat</span><span class="p">,</span> <span class="n">jaxpr</span> <span class="o">=</span> <span class="n">_python_pjit_helper</span><span class="p">(</span>
<span class="g g-Whitespace">    </span><span class="mi">257</span>         <span class="n">fun</span><span class="p">,</span> <span class="n">infer_params_fn</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">258</span>     <span class="n">executable</span> <span class="o">=</span> <span class="n">_read_most_recent_pjit_call_executable</span><span class="p">(</span><span class="n">jaxpr</span><span class="p">)</span>

<span class="nn">/usr/local/lib/python3.10/dist-packages/jax/_src/pjit.py</span> in <span class="ni">_python_pjit_helper</span><span class="nt">(fun, infer_params_fn, *args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">165</span>     <span class="n">dispatch</span><span class="o">.</span><span class="n">check_arg</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">166</span>   <span class="k">try</span><span class="p">:</span>
<span class="ne">--&gt; </span><span class="mi">167</span>     <span class="n">out_flat</span> <span class="o">=</span> <span class="n">pjit_p</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="o">*</span><span class="n">args_flat</span><span class="p">,</span> <span class="o">**</span><span class="n">params</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">168</span>   <span class="k">except</span> <span class="n">pxla</span><span class="o">.</span><span class="n">DeviceAssignmentMismatchError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">169</span>     <span class="n">fails</span><span class="p">,</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">args</span>

<span class="nn">/usr/local/lib/python3.10/dist-packages/jax/_src/core.py</span> in <span class="ni">bind</span><span class="nt">(self, *args, **params)</span>
<span class="g g-Whitespace">   </span><span class="mi">2654</span>     <span class="n">top_trace</span> <span class="o">=</span> <span class="p">(</span><span class="n">top_trace</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">axis_main</span> <span class="ow">or</span> <span class="n">axis_main</span><span class="o">.</span><span class="n">level</span> <span class="o">&lt;</span> <span class="n">top_trace</span><span class="o">.</span><span class="n">level</span>
<span class="g g-Whitespace">   </span><span class="mi">2655</span>                  <span class="k">else</span> <span class="n">axis_main</span><span class="o">.</span><span class="n">with_cur_sublevel</span><span class="p">())</span>
<span class="ne">-&gt; </span><span class="mi">2656</span>     <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">bind_with_trace</span><span class="p">(</span><span class="n">top_trace</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>
<span class="g g-Whitespace">   </span><span class="mi">2657</span> 
<span class="g g-Whitespace">   </span><span class="mi">2658</span> 

<span class="nn">/usr/local/lib/python3.10/dist-packages/jax/_src/core.py</span> in <span class="ni">bind_with_trace</span><span class="nt">(self, trace, args, params)</span>
<span class="g g-Whitespace">    </span><span class="mi">386</span> 
<span class="g g-Whitespace">    </span><span class="mi">387</span>   <span class="k">def</span> <span class="nf">bind_with_trace</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">trace</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">params</span><span class="p">):</span>
<span class="ne">--&gt; </span><span class="mi">388</span>     <span class="n">out</span> <span class="o">=</span> <span class="n">trace</span><span class="o">.</span><span class="n">process_primitive</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">map</span><span class="p">(</span><span class="n">trace</span><span class="o">.</span><span class="n">full_raise</span><span class="p">,</span> <span class="n">args</span><span class="p">),</span> <span class="n">params</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">389</span>     <span class="k">return</span> <span class="nb">map</span><span class="p">(</span><span class="n">full_lower</span><span class="p">,</span> <span class="n">out</span><span class="p">)</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">multiple_results</span> <span class="k">else</span> <span class="n">full_lower</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">390</span> 

<span class="nn">/usr/local/lib/python3.10/dist-packages/jax/_src/core.py</span> in <span class="ni">process_primitive</span><span class="nt">(self, primitive, tracers, params)</span>
<span class="g g-Whitespace">    </span><span class="mi">866</span> 
<span class="g g-Whitespace">    </span><span class="mi">867</span>   <span class="k">def</span> <span class="nf">process_primitive</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">primitive</span><span class="p">,</span> <span class="n">tracers</span><span class="p">,</span> <span class="n">params</span><span class="p">):</span>
<span class="ne">--&gt; </span><span class="mi">868</span>     <span class="k">return</span> <span class="n">primitive</span><span class="o">.</span><span class="n">impl</span><span class="p">(</span><span class="o">*</span><span class="n">tracers</span><span class="p">,</span> <span class="o">**</span><span class="n">params</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">869</span> 
<span class="g g-Whitespace">    </span><span class="mi">870</span>   <span class="k">def</span> <span class="nf">process_call</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">primitive</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">tracers</span><span class="p">,</span> <span class="n">params</span><span class="p">):</span>

<span class="nn">/usr/local/lib/python3.10/dist-packages/jax/_src/pjit.py</span> in <span class="ni">_pjit_call_impl</span><span class="nt">(jaxpr, in_shardings, out_shardings, resource_env, donated_invars, name, keep_unused, inline, *args)</span>
<span class="g g-Whitespace">   </span><span class="mi">1210</span>   <span class="n">has_explicit_sharding</span> <span class="o">=</span> <span class="n">_pjit_explicit_sharding</span><span class="p">(</span>
<span class="g g-Whitespace">   </span><span class="mi">1211</span>       <span class="n">in_shardings</span><span class="p">,</span> <span class="n">out_shardings</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
<span class="ne">-&gt; </span><span class="mi">1212</span>   <span class="k">return</span> <span class="n">xc</span><span class="o">.</span><span class="n">_xla</span><span class="o">.</span><span class="n">pjit</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">call_impl_cache_miss</span><span class="p">,</span> <span class="p">[],</span> <span class="p">[],</span> <span class="n">donated_argnums</span><span class="p">,</span>
<span class="g g-Whitespace">   </span><span class="mi">1213</span>                       <span class="n">tree_util</span><span class="o">.</span><span class="n">dispatch_registry</span><span class="p">,</span>
<span class="g g-Whitespace">   </span><span class="mi">1214</span>                       <span class="n">_get_cpp_global_cache</span><span class="p">(</span><span class="n">has_explicit_sharding</span><span class="p">))(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>

<span class="nn">/usr/local/lib/python3.10/dist-packages/jax/_src/pjit.py</span> in <span class="ni">call_impl_cache_miss</span><span class="nt">(*args_, **kwargs_)</span>
<span class="g g-Whitespace">   </span><span class="mi">1194</span>                     <span class="n">donated_invars</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">keep_unused</span><span class="p">,</span> <span class="n">inline</span><span class="p">):</span>
<span class="g g-Whitespace">   </span><span class="mi">1195</span>   <span class="k">def</span> <span class="nf">call_impl_cache_miss</span><span class="p">(</span><span class="o">*</span><span class="n">args_</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs_</span><span class="p">):</span>
<span class="ne">-&gt; </span><span class="mi">1196</span>     <span class="n">out_flat</span><span class="p">,</span> <span class="n">compiled</span> <span class="o">=</span> <span class="n">_pjit_call_impl_python</span><span class="p">(</span>
<span class="g g-Whitespace">   </span><span class="mi">1197</span>         <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">jaxpr</span><span class="o">=</span><span class="n">jaxpr</span><span class="p">,</span> <span class="n">in_shardings</span><span class="o">=</span><span class="n">in_shardings</span><span class="p">,</span>
<span class="g g-Whitespace">   </span><span class="mi">1198</span>         <span class="n">out_shardings</span><span class="o">=</span><span class="n">out_shardings</span><span class="p">,</span> <span class="n">resource_env</span><span class="o">=</span><span class="n">resource_env</span><span class="p">,</span>

<span class="nn">/usr/local/lib/python3.10/dist-packages/jax/_src/pjit.py</span> in <span class="ni">_pjit_call_impl_python</span><span class="nt">(jaxpr, in_shardings, out_shardings, resource_env, donated_invars, name, keep_unused, inline, *args)</span>
<span class="g g-Whitespace">   </span><span class="mi">1127</span>       <span class="n">resource_env</span><span class="o">.</span><span class="n">physical_mesh</span> <span class="k">if</span> <span class="n">resource_env</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span>
<span class="g g-Whitespace">   </span><span class="mi">1128</span> 
<span class="ne">-&gt; </span><span class="mi">1129</span>   <span class="n">compiled</span> <span class="o">=</span> <span class="n">_pjit_lower</span><span class="p">(</span>
<span class="g g-Whitespace">   </span><span class="mi">1130</span>       <span class="n">jaxpr</span><span class="p">,</span> <span class="n">in_shardings</span><span class="p">,</span> <span class="n">out_shardings</span><span class="p">,</span> <span class="n">resource_env</span><span class="p">,</span>
<span class="g g-Whitespace">   </span><span class="mi">1131</span>       <span class="n">donated_invars</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">keep_unused</span><span class="p">,</span> <span class="n">inline</span><span class="p">,</span>

<span class="nn">/usr/local/lib/python3.10/dist-packages/jax/_src/pjit.py</span> in <span class="ni">_pjit_lower</span><span class="nt">(jaxpr, in_shardings, out_shardings, *args, **kwargs)</span>
<span class="g g-Whitespace">   </span><span class="mi">1258</span>   <span class="n">in_shardings</span> <span class="o">=</span> <span class="n">SameDeviceAssignmentTuple</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="n">in_shardings</span><span class="p">),</span> <span class="n">da</span><span class="p">)</span>
<span class="g g-Whitespace">   </span><span class="mi">1259</span>   <span class="n">out_shardings</span> <span class="o">=</span> <span class="n">SameDeviceAssignmentTuple</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="n">out_shardings</span><span class="p">),</span> <span class="n">da</span><span class="p">)</span>
<span class="ne">-&gt; </span><span class="mi">1260</span>   <span class="k">return</span> <span class="n">_pjit_lower_cached</span><span class="p">(</span><span class="n">jaxpr</span><span class="p">,</span> <span class="n">in_shardings</span><span class="p">,</span> <span class="n">out_shardings</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="g g-Whitespace">   </span><span class="mi">1261</span> 
<span class="g g-Whitespace">   </span><span class="mi">1262</span> 

<span class="nn">/usr/local/lib/python3.10/dist-packages/jax/_src/pjit.py</span> in <span class="ni">_pjit_lower_cached</span><span class="nt">(jaxpr, sdat_in_shardings, sdat_out_shardings, resource_env, donated_invars, name, keep_unused, inline, lowering_parameters)</span>
<span class="g g-Whitespace">   </span><span class="mi">1297</span>       <span class="n">lowering_parameters</span><span class="o">=</span><span class="n">lowering_parameters</span><span class="p">)</span>
<span class="g g-Whitespace">   </span><span class="mi">1298</span>   <span class="k">else</span><span class="p">:</span>
<span class="ne">-&gt; </span><span class="mi">1299</span>     <span class="k">return</span> <span class="n">pxla</span><span class="o">.</span><span class="n">lower_sharding_computation</span><span class="p">(</span>
<span class="g g-Whitespace">   </span><span class="mi">1300</span>         <span class="n">jaxpr</span><span class="p">,</span> <span class="n">api_name</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">in_shardings</span><span class="p">,</span> <span class="n">out_shardings</span><span class="p">,</span>
<span class="g g-Whitespace">   </span><span class="mi">1301</span>         <span class="nb">tuple</span><span class="p">(</span><span class="n">donated_invars</span><span class="p">),</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">jaxpr</span><span class="o">.</span><span class="n">in_avals</span><span class="p">),</span>

<span class="nn">/usr/local/lib/python3.10/dist-packages/jax/_src/profiler.py</span> in <span class="ni">wrapper</span><span class="nt">(*args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">338</span>   <span class="k">def</span> <span class="nf">wrapper</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="g g-Whitespace">    </span><span class="mi">339</span>     <span class="k">with</span> <span class="n">TraceAnnotation</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="o">**</span><span class="n">decorator_kwargs</span><span class="p">):</span>
<span class="ne">--&gt; </span><span class="mi">340</span>       <span class="k">return</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">341</span>     <span class="k">return</span> <span class="n">wrapper</span>
<span class="g g-Whitespace">    </span><span class="mi">342</span>   <span class="k">return</span> <span class="n">wrapper</span>

<span class="nn">/usr/local/lib/python3.10/dist-packages/jax/_src/interpreters/pxla.py</span> in <span class="ni">lower_sharding_computation</span><span class="nt">(fun_or_jaxpr, api_name, fun_name, in_shardings, out_shardings, donated_invars, global_in_avals, keep_unused, inline, devices_from_context, lowering_parameters)</span>
<span class="g g-Whitespace">   </span><span class="mi">2029</span>   <span class="n">semantic_out_shardings</span> <span class="o">=</span> <span class="n">SemanticallyEqualShardings</span><span class="p">(</span><span class="n">out_shardings</span><span class="p">)</span>
<span class="g g-Whitespace">   </span><span class="mi">2030</span>   <span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">keepalive</span><span class="p">,</span> <span class="n">host_callbacks</span><span class="p">,</span> <span class="n">unordered_effects</span><span class="p">,</span> <span class="n">ordered_effects</span><span class="p">,</span>
<span class="ne">-&gt; </span><span class="mi">2031</span>    <span class="n">nreps</span><span class="p">,</span> <span class="n">tuple_args</span><span class="p">,</span> <span class="n">shape_poly_state</span><span class="p">)</span> <span class="o">=</span> <span class="n">_cached_lowering_to_hlo</span><span class="p">(</span>
<span class="g g-Whitespace">   </span><span class="mi">2032</span>        <span class="n">closed_jaxpr</span><span class="p">,</span> <span class="n">api_name</span><span class="p">,</span> <span class="n">fun_name</span><span class="p">,</span> <span class="n">backend</span><span class="p">,</span> <span class="n">semantic_in_shardings</span><span class="p">,</span>
<span class="g g-Whitespace">   </span><span class="mi">2033</span>        <span class="n">semantic_out_shardings</span><span class="p">,</span> <span class="n">da_object</span><span class="p">,</span>

<span class="nn">/usr/local/lib/python3.10/dist-packages/jax/_src/interpreters/pxla.py</span> in <span class="ni">_cached_lowering_to_hlo</span><span class="nt">(closed_jaxpr, api_name, fun_name, backend, semantic_in_shardings, semantic_out_shardings, da_object, donated_invars, name_stack, all_default_mem_kind, lowering_parameters)</span>
<span class="g g-Whitespace">   </span><span class="mi">1830</span>         <span class="s2">&quot;Finished jaxpr to MLIR module conversion </span><span class="si">{fun_name}</span><span class="s2"> in </span><span class="si">{elapsed_time}</span><span class="s2"> sec&quot;</span><span class="p">,</span>
<span class="g g-Whitespace">   </span><span class="mi">1831</span>         <span class="n">fun_name</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">name_stack</span><span class="p">),</span> <span class="n">event</span><span class="o">=</span><span class="n">dispatch</span><span class="o">.</span><span class="n">JAXPR_TO_MLIR_MODULE_EVENT</span><span class="p">):</span>
<span class="ne">-&gt; </span><span class="mi">1832</span>     <span class="n">lowering_result</span> <span class="o">=</span> <span class="n">mlir</span><span class="o">.</span><span class="n">lower_jaxpr_to_module</span><span class="p">(</span>
<span class="g g-Whitespace">   </span><span class="mi">1833</span>         <span class="n">module_name</span><span class="p">,</span>
<span class="g g-Whitespace">   </span><span class="mi">1834</span>         <span class="n">closed_jaxpr</span><span class="p">,</span>

<span class="nn">/usr/local/lib/python3.10/dist-packages/jax/_src/interpreters/mlir.py</span> in <span class="ni">lower_jaxpr_to_module</span><span class="nt">(module_name, jaxpr, ordered_effects, backend_or_name, platforms, axis_context, name_stack, donated_args, replicated_args, arg_shardings, result_shardings, arg_names, result_names, num_replicas, num_partitions, all_default_mem_kind, lowering_parameters)</span>
<span class="g g-Whitespace">    </span><span class="mi">804</span>     <span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;mhlo.num_partitions&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">i32_attr</span><span class="p">(</span><span class="n">num_partitions</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">805</span>     <span class="n">replace_tokens_with_dummy</span> <span class="o">=</span> <span class="n">lowering_parameters</span><span class="o">.</span><span class="n">replace_tokens_with_dummy</span>
<span class="ne">--&gt; </span><span class="mi">806</span>     <span class="n">lower_jaxpr_to_fun</span><span class="p">(</span>
<span class="g g-Whitespace">    </span><span class="mi">807</span>         <span class="n">ctx</span><span class="p">,</span> <span class="s2">&quot;main&quot;</span><span class="p">,</span> <span class="n">jaxpr</span><span class="p">,</span> <span class="n">ordered_effects</span><span class="p">,</span> <span class="n">public</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">808</span>         <span class="n">create_tokens</span><span class="o">=</span><span class="n">replace_tokens_with_dummy</span><span class="p">,</span>

<span class="nn">/usr/local/lib/python3.10/dist-packages/jax/_src/interpreters/mlir.py</span> in <span class="ni">lower_jaxpr_to_fun</span><span class="nt">(ctx, name, jaxpr, effects, create_tokens, public, replace_tokens_with_dummy, replicated_args, arg_shardings, result_shardings, use_sharding_annotations, input_output_aliases, num_output_tokens, api_name, arg_names, result_names, arg_memory_kinds, result_memory_kinds)</span>
<span class="g g-Whitespace">   </span><span class="mi">1211</span>     <span class="n">callee_name_stack</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">.</span><span class="n">name_stack</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">util</span><span class="o">.</span><span class="n">wrap_name</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">api_name</span><span class="p">))</span>
<span class="g g-Whitespace">   </span><span class="mi">1212</span>     <span class="n">consts</span> <span class="o">=</span> <span class="p">[</span><span class="n">ir_constants</span><span class="p">(</span><span class="n">xla</span><span class="o">.</span><span class="n">canonicalize_dtype</span><span class="p">(</span><span class="n">x</span><span class="p">))</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">jaxpr</span><span class="o">.</span><span class="n">consts</span><span class="p">]</span>
<span class="ne">-&gt; </span><span class="mi">1213</span>     <span class="n">out_vals</span><span class="p">,</span> <span class="n">tokens_out</span> <span class="o">=</span> <span class="n">jaxpr_subcomp</span><span class="p">(</span>
<span class="g g-Whitespace">   </span><span class="mi">1214</span>         <span class="n">ctx</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">name_stack</span><span class="o">=</span><span class="n">callee_name_stack</span><span class="p">),</span> <span class="n">jaxpr</span><span class="o">.</span><span class="n">jaxpr</span><span class="p">,</span> <span class="n">tokens_in</span><span class="p">,</span>
<span class="g g-Whitespace">   </span><span class="mi">1215</span>         <span class="n">consts</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">dim_var_values</span><span class="o">=</span><span class="n">dim_var_values</span><span class="p">)</span>

<span class="nn">/usr/local/lib/python3.10/dist-packages/jax/_src/interpreters/mlir.py</span> in <span class="ni">jaxpr_subcomp</span><span class="nt">(ctx, jaxpr, tokens, consts, dim_var_values, *args)</span>
<span class="g g-Whitespace">   </span><span class="mi">1429</span>       <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ctx</span><span class="o">.</span><span class="n">platforms</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
<span class="g g-Whitespace">   </span><span class="mi">1430</span>         <span class="c1"># Classic, single-platform lowering</span>
<span class="ne">-&gt; </span><span class="mi">1431</span>         <span class="n">ans</span> <span class="o">=</span> <span class="n">rule</span><span class="p">(</span><span class="n">rule_ctx</span><span class="p">,</span> <span class="o">*</span><span class="n">rule_inputs</span><span class="p">,</span> <span class="o">**</span><span class="n">eqn</span><span class="o">.</span><span class="n">params</span><span class="p">)</span>
<span class="g g-Whitespace">   </span><span class="mi">1432</span>       <span class="k">else</span><span class="p">:</span>
<span class="g g-Whitespace">   </span><span class="mi">1433</span>         <span class="n">ans</span> <span class="o">=</span> <span class="n">lower_multi_platform</span><span class="p">(</span><span class="n">rule_ctx</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">eqn</span><span class="p">),</span> <span class="n">rules</span><span class="p">,</span>

<span class="nn">/usr/local/lib/python3.10/dist-packages/jax/_src/interpreters/mlir.py</span> in <span class="ni">f_lowered</span><span class="nt">(ctx, *args, **params)</span>
<span class="g g-Whitespace">   </span><span class="mi">1626</span>       <span class="c1"># TODO(frostig,mattjj): check ctx.avals_out against jaxpr avals out?</span>
<span class="g g-Whitespace">   </span><span class="mi">1627</span> 
<span class="ne">-&gt; </span><span class="mi">1628</span>     <span class="n">out</span><span class="p">,</span> <span class="n">tokens</span> <span class="o">=</span> <span class="n">jaxpr_subcomp</span><span class="p">(</span>
<span class="g g-Whitespace">   </span><span class="mi">1629</span>         <span class="n">ctx</span><span class="o">.</span><span class="n">module_context</span><span class="p">,</span> <span class="n">jaxpr</span><span class="p">,</span> <span class="n">ctx</span><span class="o">.</span><span class="n">tokens_in</span><span class="p">,</span> <span class="n">_ir_consts</span><span class="p">(</span><span class="n">consts</span><span class="p">),</span>
<span class="g g-Whitespace">   </span><span class="mi">1630</span>         <span class="o">*</span><span class="nb">map</span><span class="p">(</span><span class="n">wrap_singleton_ir_values</span><span class="p">,</span> <span class="n">args</span><span class="p">),</span> <span class="n">dim_var_values</span><span class="o">=</span><span class="n">ctx</span><span class="o">.</span><span class="n">dim_var_values</span><span class="p">)</span>

<span class="nn">/usr/local/lib/python3.10/dist-packages/jax/_src/interpreters/mlir.py</span> in <span class="ni">jaxpr_subcomp</span><span class="nt">(ctx, jaxpr, tokens, consts, dim_var_values, *args)</span>
<span class="g g-Whitespace">   </span><span class="mi">1429</span>       <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ctx</span><span class="o">.</span><span class="n">platforms</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
<span class="g g-Whitespace">   </span><span class="mi">1430</span>         <span class="c1"># Classic, single-platform lowering</span>
<span class="ne">-&gt; </span><span class="mi">1431</span>         <span class="n">ans</span> <span class="o">=</span> <span class="n">rule</span><span class="p">(</span><span class="n">rule_ctx</span><span class="p">,</span> <span class="o">*</span><span class="n">rule_inputs</span><span class="p">,</span> <span class="o">**</span><span class="n">eqn</span><span class="o">.</span><span class="n">params</span><span class="p">)</span>
<span class="g g-Whitespace">   </span><span class="mi">1432</span>       <span class="k">else</span><span class="p">:</span>
<span class="g g-Whitespace">   </span><span class="mi">1433</span>         <span class="n">ans</span> <span class="o">=</span> <span class="n">lower_multi_platform</span><span class="p">(</span><span class="n">rule_ctx</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">eqn</span><span class="p">),</span> <span class="n">rules</span><span class="p">,</span>

<span class="nn">/usr/local/lib/python3.10/dist-packages/jax/_src/lax/control_flow/loops.py</span> in <span class="ni">_while_lowering</span><span class="nt">(ctx, cond_jaxpr, body_jaxpr, cond_nconsts, body_nconsts, *args)</span>
<span class="g g-Whitespace">   </span><span class="mi">1670</span>     <span class="n">body_consts</span> <span class="o">=</span> <span class="p">[</span><span class="n">mlir</span><span class="o">.</span><span class="n">ir_constants</span><span class="p">(</span><span class="n">xla</span><span class="o">.</span><span class="n">canonicalize_dtype</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
<span class="g g-Whitespace">   </span><span class="mi">1671</span>                    <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">body_jaxpr</span><span class="o">.</span><span class="n">consts</span><span class="p">]</span>
<span class="ne">-&gt; </span><span class="mi">1672</span>     <span class="n">new_z</span><span class="p">,</span> <span class="n">tokens_out</span> <span class="o">=</span> <span class="n">mlir</span><span class="o">.</span><span class="n">jaxpr_subcomp</span><span class="p">(</span><span class="n">body_ctx</span><span class="p">,</span> <span class="n">body_jaxpr</span><span class="o">.</span><span class="n">jaxpr</span><span class="p">,</span>
<span class="g g-Whitespace">   </span><span class="mi">1673</span>         <span class="n">tokens_in</span><span class="p">,</span> <span class="n">body_consts</span><span class="p">,</span> <span class="o">*</span><span class="p">(</span><span class="n">y</span> <span class="o">+</span> <span class="n">z</span><span class="p">),</span> <span class="n">dim_var_values</span><span class="o">=</span><span class="n">ctx</span><span class="o">.</span><span class="n">dim_var_values</span><span class="p">)</span>
<span class="g g-Whitespace">   </span><span class="mi">1674</span>     <span class="n">out_tokens</span> <span class="o">=</span> <span class="p">[</span><span class="n">tokens_out</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">eff</span><span class="p">)</span> <span class="k">for</span> <span class="n">eff</span> <span class="ow">in</span> <span class="n">body_effects</span><span class="p">]</span>

<span class="nn">/usr/local/lib/python3.10/dist-packages/jax/_src/interpreters/mlir.py</span> in <span class="ni">jaxpr_subcomp</span><span class="nt">(ctx, jaxpr, tokens, consts, dim_var_values, *args)</span>
<span class="g g-Whitespace">   </span><span class="mi">1429</span>       <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ctx</span><span class="o">.</span><span class="n">platforms</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
<span class="g g-Whitespace">   </span><span class="mi">1430</span>         <span class="c1"># Classic, single-platform lowering</span>
<span class="ne">-&gt; </span><span class="mi">1431</span>         <span class="n">ans</span> <span class="o">=</span> <span class="n">rule</span><span class="p">(</span><span class="n">rule_ctx</span><span class="p">,</span> <span class="o">*</span><span class="n">rule_inputs</span><span class="p">,</span> <span class="o">**</span><span class="n">eqn</span><span class="o">.</span><span class="n">params</span><span class="p">)</span>
<span class="g g-Whitespace">   </span><span class="mi">1432</span>       <span class="k">else</span><span class="p">:</span>
<span class="g g-Whitespace">   </span><span class="mi">1433</span>         <span class="n">ans</span> <span class="o">=</span> <span class="n">lower_multi_platform</span><span class="p">(</span><span class="n">rule_ctx</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">eqn</span><span class="p">),</span> <span class="n">rules</span><span class="p">,</span>

<span class="nn">/usr/local/lib/python3.10/dist-packages/jax/_src/interpreters/mlir.py</span> in <span class="ni">f_lowered</span><span class="nt">(ctx, *args, **params)</span>
<span class="g g-Whitespace">   </span><span class="mi">1626</span>       <span class="c1"># TODO(frostig,mattjj): check ctx.avals_out against jaxpr avals out?</span>
<span class="g g-Whitespace">   </span><span class="mi">1627</span> 
<span class="ne">-&gt; </span><span class="mi">1628</span>     <span class="n">out</span><span class="p">,</span> <span class="n">tokens</span> <span class="o">=</span> <span class="n">jaxpr_subcomp</span><span class="p">(</span>
<span class="g g-Whitespace">   </span><span class="mi">1629</span>         <span class="n">ctx</span><span class="o">.</span><span class="n">module_context</span><span class="p">,</span> <span class="n">jaxpr</span><span class="p">,</span> <span class="n">ctx</span><span class="o">.</span><span class="n">tokens_in</span><span class="p">,</span> <span class="n">_ir_consts</span><span class="p">(</span><span class="n">consts</span><span class="p">),</span>
<span class="g g-Whitespace">   </span><span class="mi">1630</span>         <span class="o">*</span><span class="nb">map</span><span class="p">(</span><span class="n">wrap_singleton_ir_values</span><span class="p">,</span> <span class="n">args</span><span class="p">),</span> <span class="n">dim_var_values</span><span class="o">=</span><span class="n">ctx</span><span class="o">.</span><span class="n">dim_var_values</span><span class="p">)</span>

<span class="nn">/usr/local/lib/python3.10/dist-packages/jax/_src/interpreters/mlir.py</span> in <span class="ni">jaxpr_subcomp</span><span class="nt">(ctx, jaxpr, tokens, consts, dim_var_values, *args)</span>
<span class="g g-Whitespace">   </span><span class="mi">1429</span>       <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ctx</span><span class="o">.</span><span class="n">platforms</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
<span class="g g-Whitespace">   </span><span class="mi">1430</span>         <span class="c1"># Classic, single-platform lowering</span>
<span class="ne">-&gt; </span><span class="mi">1431</span>         <span class="n">ans</span> <span class="o">=</span> <span class="n">rule</span><span class="p">(</span><span class="n">rule_ctx</span><span class="p">,</span> <span class="o">*</span><span class="n">rule_inputs</span><span class="p">,</span> <span class="o">**</span><span class="n">eqn</span><span class="o">.</span><span class="n">params</span><span class="p">)</span>
<span class="g g-Whitespace">   </span><span class="mi">1432</span>       <span class="k">else</span><span class="p">:</span>
<span class="g g-Whitespace">   </span><span class="mi">1433</span>         <span class="n">ans</span> <span class="o">=</span> <span class="n">lower_multi_platform</span><span class="p">(</span><span class="n">rule_ctx</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">eqn</span><span class="p">),</span> <span class="n">rules</span><span class="p">,</span>

<span class="nn">/usr/local/lib/python3.10/dist-packages/jax/_src/lax/control_flow/loops.py</span> in <span class="ni">_while_lowering</span><span class="nt">(ctx, cond_jaxpr, body_jaxpr, cond_nconsts, body_nconsts, *args)</span>
<span class="g g-Whitespace">   </span><span class="mi">1632</span>         <span class="n">mlir</span><span class="o">.</span><span class="n">ir_constants</span><span class="p">(</span><span class="n">xla</span><span class="o">.</span><span class="n">canonicalize_dtype</span><span class="p">(</span><span class="n">x</span><span class="p">))</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">cond_jaxpr</span><span class="o">.</span><span class="n">consts</span>
<span class="g g-Whitespace">   </span><span class="mi">1633</span>     <span class="p">]</span>
<span class="ne">-&gt; </span><span class="mi">1634</span>     <span class="p">((</span><span class="n">pred</span><span class="p">,),),</span> <span class="n">_</span> <span class="o">=</span> <span class="n">mlir</span><span class="o">.</span><span class="n">jaxpr_subcomp</span><span class="p">(</span>
<span class="g g-Whitespace">   </span><span class="mi">1635</span>         <span class="n">cond_ctx</span><span class="p">,</span>
<span class="g g-Whitespace">   </span><span class="mi">1636</span>         <span class="n">cond_jaxpr</span><span class="o">.</span><span class="n">jaxpr</span><span class="p">,</span>

<span class="nn">/usr/local/lib/python3.10/dist-packages/jax/_src/interpreters/mlir.py</span> in <span class="ni">jaxpr_subcomp</span><span class="nt">(ctx, jaxpr, tokens, consts, dim_var_values, *args)</span>
<span class="g g-Whitespace">   </span><span class="mi">1313</span>   <span class="k">return</span> <span class="n">func_op</span>
<span class="g g-Whitespace">   </span><span class="mi">1314</span> 
<span class="ne">-&gt; </span><span class="mi">1315</span> <span class="k">def</span> <span class="nf">jaxpr_subcomp</span><span class="p">(</span><span class="n">ctx</span><span class="p">:</span> <span class="n">ModuleContext</span><span class="p">,</span> <span class="n">jaxpr</span><span class="p">:</span> <span class="n">core</span><span class="o">.</span><span class="n">Jaxpr</span><span class="p">,</span>
<span class="g g-Whitespace">   </span><span class="mi">1316</span>                   <span class="n">tokens</span><span class="p">:</span> <span class="n">TokenSet</span><span class="p">,</span>
<span class="g g-Whitespace">   </span><span class="mi">1317</span>                   <span class="n">consts</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="n">ir</span><span class="o">.</span><span class="n">Value</span><span class="p">]],</span>

<span class="ne">KeyboardInterrupt</span>: 
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#@title Display 3D structure {run: &quot;auto&quot;}</span>
<span class="kn">import</span> <span class="nn">py3Dmol</span>
<span class="kn">import</span> <span class="nn">glob</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">colabfold.colabfold</span> <span class="kn">import</span> <span class="n">plot_plddt_legend</span>
<span class="kn">from</span> <span class="nn">colabfold.colabfold</span> <span class="kn">import</span> <span class="n">pymol_color_list</span><span class="p">,</span> <span class="n">alphabet_list</span>
<span class="n">rank_num</span> <span class="o">=</span> <span class="mi">1</span> <span class="c1">#@param [&quot;1&quot;, &quot;2&quot;, &quot;3&quot;, &quot;4&quot;, &quot;5&quot;] {type:&quot;raw&quot;}</span>
<span class="n">color</span> <span class="o">=</span> <span class="s2">&quot;lDDT&quot;</span> <span class="c1">#@param [&quot;chain&quot;, &quot;lDDT&quot;, &quot;rainbow&quot;]</span>
<span class="n">show_sidechains</span> <span class="o">=</span> <span class="kc">False</span> <span class="c1">#@param {type:&quot;boolean&quot;}</span>
<span class="n">show_mainchains</span> <span class="o">=</span> <span class="kc">False</span> <span class="c1">#@param {type:&quot;boolean&quot;}</span>

<span class="n">tag</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="s2">&quot;rank&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="n">rank_num</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
<span class="n">jobname_prefix</span> <span class="o">=</span> <span class="s2">&quot;.custom&quot;</span> <span class="k">if</span> <span class="n">msa_mode</span> <span class="o">==</span> <span class="s2">&quot;custom&quot;</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
<span class="n">pdb_filename</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">jobname</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">jobname</span><span class="si">}{</span><span class="n">jobname_prefix</span><span class="si">}</span><span class="s2">_unrelaxed_</span><span class="si">{</span><span class="n">tag</span><span class="si">}</span><span class="s2">.pdb&quot;</span>
<span class="n">pdb_file</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">pdb_filename</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">show_pdb</span><span class="p">(</span><span class="n">rank_num</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">show_sidechains</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">show_mainchains</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;lDDT&quot;</span><span class="p">):</span>
  <span class="n">model_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;rank_</span><span class="si">{</span><span class="n">rank_num</span><span class="si">}</span><span class="s2">&quot;</span>
  <span class="n">view</span> <span class="o">=</span> <span class="n">py3Dmol</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">js</span><span class="o">=</span><span class="s1">&#39;https://3dmol.org/build/3Dmol.js&#39;</span><span class="p">,)</span>
  <span class="n">view</span><span class="o">.</span><span class="n">addModel</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="n">pdb_file</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="s1">&#39;r&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">(),</span><span class="s1">&#39;pdb&#39;</span><span class="p">)</span>

  <span class="k">if</span> <span class="n">color</span> <span class="o">==</span> <span class="s2">&quot;lDDT&quot;</span><span class="p">:</span>
    <span class="n">view</span><span class="o">.</span><span class="n">setStyle</span><span class="p">({</span><span class="s1">&#39;cartoon&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;colorscheme&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;prop&#39;</span><span class="p">:</span><span class="s1">&#39;b&#39;</span><span class="p">,</span><span class="s1">&#39;gradient&#39;</span><span class="p">:</span> <span class="s1">&#39;roygb&#39;</span><span class="p">,</span><span class="s1">&#39;min&#39;</span><span class="p">:</span><span class="mi">50</span><span class="p">,</span><span class="s1">&#39;max&#39;</span><span class="p">:</span><span class="mi">90</span><span class="p">}}})</span>
  <span class="k">elif</span> <span class="n">color</span> <span class="o">==</span> <span class="s2">&quot;rainbow&quot;</span><span class="p">:</span>
    <span class="n">view</span><span class="o">.</span><span class="n">setStyle</span><span class="p">({</span><span class="s1">&#39;cartoon&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;color&#39;</span><span class="p">:</span><span class="s1">&#39;spectrum&#39;</span><span class="p">}})</span>
  <span class="k">elif</span> <span class="n">color</span> <span class="o">==</span> <span class="s2">&quot;chain&quot;</span><span class="p">:</span>
    <span class="n">chains</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">queries</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span> <span class="o">+</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">is_complex</span> <span class="k">else</span> <span class="mi">1</span>
    <span class="k">for</span> <span class="n">n</span><span class="p">,</span><span class="n">chain</span><span class="p">,</span><span class="n">color</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">chains</span><span class="p">),</span><span class="n">alphabet_list</span><span class="p">,</span><span class="n">pymol_color_list</span><span class="p">):</span>
       <span class="n">view</span><span class="o">.</span><span class="n">setStyle</span><span class="p">({</span><span class="s1">&#39;chain&#39;</span><span class="p">:</span><span class="n">chain</span><span class="p">},{</span><span class="s1">&#39;cartoon&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;color&#39;</span><span class="p">:</span><span class="n">color</span><span class="p">}})</span>

  <span class="k">if</span> <span class="n">show_sidechains</span><span class="p">:</span>
    <span class="n">BB</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;C&#39;</span><span class="p">,</span><span class="s1">&#39;O&#39;</span><span class="p">,</span><span class="s1">&#39;N&#39;</span><span class="p">]</span>
    <span class="n">view</span><span class="o">.</span><span class="n">addStyle</span><span class="p">({</span><span class="s1">&#39;and&#39;</span><span class="p">:[{</span><span class="s1">&#39;resn&#39;</span><span class="p">:[</span><span class="s2">&quot;GLY&quot;</span><span class="p">,</span><span class="s2">&quot;PRO&quot;</span><span class="p">],</span><span class="s1">&#39;invert&#39;</span><span class="p">:</span><span class="kc">True</span><span class="p">},{</span><span class="s1">&#39;atom&#39;</span><span class="p">:</span><span class="n">BB</span><span class="p">,</span><span class="s1">&#39;invert&#39;</span><span class="p">:</span><span class="kc">True</span><span class="p">}]},</span>
                        <span class="p">{</span><span class="s1">&#39;stick&#39;</span><span class="p">:{</span><span class="s1">&#39;colorscheme&#39;</span><span class="p">:</span><span class="sa">f</span><span class="s2">&quot;WhiteCarbon&quot;</span><span class="p">,</span><span class="s1">&#39;radius&#39;</span><span class="p">:</span><span class="mf">0.3</span><span class="p">}})</span>
    <span class="n">view</span><span class="o">.</span><span class="n">addStyle</span><span class="p">({</span><span class="s1">&#39;and&#39;</span><span class="p">:[{</span><span class="s1">&#39;resn&#39;</span><span class="p">:</span><span class="s2">&quot;GLY&quot;</span><span class="p">},{</span><span class="s1">&#39;atom&#39;</span><span class="p">:</span><span class="s1">&#39;CA&#39;</span><span class="p">}]},</span>
                        <span class="p">{</span><span class="s1">&#39;sphere&#39;</span><span class="p">:{</span><span class="s1">&#39;colorscheme&#39;</span><span class="p">:</span><span class="sa">f</span><span class="s2">&quot;WhiteCarbon&quot;</span><span class="p">,</span><span class="s1">&#39;radius&#39;</span><span class="p">:</span><span class="mf">0.3</span><span class="p">}})</span>
    <span class="n">view</span><span class="o">.</span><span class="n">addStyle</span><span class="p">({</span><span class="s1">&#39;and&#39;</span><span class="p">:[{</span><span class="s1">&#39;resn&#39;</span><span class="p">:</span><span class="s2">&quot;PRO&quot;</span><span class="p">},{</span><span class="s1">&#39;atom&#39;</span><span class="p">:[</span><span class="s1">&#39;C&#39;</span><span class="p">,</span><span class="s1">&#39;O&#39;</span><span class="p">],</span><span class="s1">&#39;invert&#39;</span><span class="p">:</span><span class="kc">True</span><span class="p">}]},</span>
                        <span class="p">{</span><span class="s1">&#39;stick&#39;</span><span class="p">:{</span><span class="s1">&#39;colorscheme&#39;</span><span class="p">:</span><span class="sa">f</span><span class="s2">&quot;WhiteCarbon&quot;</span><span class="p">,</span><span class="s1">&#39;radius&#39;</span><span class="p">:</span><span class="mf">0.3</span><span class="p">}})</span>
  <span class="k">if</span> <span class="n">show_mainchains</span><span class="p">:</span>
    <span class="n">BB</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;C&#39;</span><span class="p">,</span><span class="s1">&#39;O&#39;</span><span class="p">,</span><span class="s1">&#39;N&#39;</span><span class="p">,</span><span class="s1">&#39;CA&#39;</span><span class="p">]</span>
    <span class="n">view</span><span class="o">.</span><span class="n">addStyle</span><span class="p">({</span><span class="s1">&#39;atom&#39;</span><span class="p">:</span><span class="n">BB</span><span class="p">},{</span><span class="s1">&#39;stick&#39;</span><span class="p">:{</span><span class="s1">&#39;colorscheme&#39;</span><span class="p">:</span><span class="sa">f</span><span class="s2">&quot;WhiteCarbon&quot;</span><span class="p">,</span><span class="s1">&#39;radius&#39;</span><span class="p">:</span><span class="mf">0.3</span><span class="p">}})</span>

  <span class="n">view</span><span class="o">.</span><span class="n">zoomTo</span><span class="p">()</span>
  <span class="k">return</span> <span class="n">view</span>

<span class="n">show_pdb</span><span class="p">(</span><span class="n">rank_num</span><span class="p">,</span> <span class="n">show_sidechains</span><span class="p">,</span> <span class="n">show_mainchains</span><span class="p">,</span> <span class="n">color</span><span class="p">)</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
<span class="k">if</span> <span class="n">color</span> <span class="o">==</span> <span class="s2">&quot;lDDT&quot;</span><span class="p">:</span>
  <span class="n">plot_plddt_legend</span><span class="p">()</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#@title Plots {run: &quot;auto&quot;}</span>
<span class="kn">from</span> <span class="nn">IPython.display</span> <span class="kn">import</span> <span class="n">display</span><span class="p">,</span> <span class="n">HTML</span>
<span class="kn">import</span> <span class="nn">base64</span>
<span class="kn">from</span> <span class="nn">html</span> <span class="kn">import</span> <span class="n">escape</span>

<span class="c1"># see: https://stackoverflow.com/a/53688522</span>
<span class="k">def</span> <span class="nf">image_to_data_url</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
  <span class="n">ext</span> <span class="o">=</span> <span class="n">filename</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
  <span class="n">prefix</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;data:image/</span><span class="si">{</span><span class="n">ext</span><span class="si">}</span><span class="s1">;base64,&#39;</span>
  <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">img</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
  <span class="k">return</span> <span class="n">prefix</span> <span class="o">+</span> <span class="n">base64</span><span class="o">.</span><span class="n">b64encode</span><span class="p">(</span><span class="n">img</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>

<span class="n">pae</span> <span class="o">=</span> <span class="n">image_to_data_url</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">jobname</span><span class="p">,</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">jobname</span><span class="si">}{</span><span class="n">jobname_prefix</span><span class="si">}</span><span class="s2">_pae.png&quot;</span><span class="p">))</span>
<span class="n">cov</span> <span class="o">=</span> <span class="n">image_to_data_url</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">jobname</span><span class="p">,</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">jobname</span><span class="si">}{</span><span class="n">jobname_prefix</span><span class="si">}</span><span class="s2">_coverage.png&quot;</span><span class="p">))</span>
<span class="n">plddt</span> <span class="o">=</span> <span class="n">image_to_data_url</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">jobname</span><span class="p">,</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">jobname</span><span class="si">}{</span><span class="n">jobname_prefix</span><span class="si">}</span><span class="s2">_plddt.png&quot;</span><span class="p">))</span>
<span class="n">display</span><span class="p">(</span><span class="n">HTML</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">&lt;style&gt;</span>
<span class="s2">  img </span><span class="se">{{</span>
<span class="s2">    float:left;</span>
<span class="s2">  </span><span class="se">}}</span>
<span class="s2">  .full </span><span class="se">{{</span>
<span class="s2">    max-width:100%;</span>
<span class="s2">  </span><span class="se">}}</span>
<span class="s2">  .half </span><span class="se">{{</span>
<span class="s2">    max-width:50%;</span>
<span class="s2">  </span><span class="se">}}</span>
<span class="s2">  @media (max-width:640px) </span><span class="se">{{</span>
<span class="s2">    .half </span><span class="se">{{</span>
<span class="s2">      max-width:100%;</span>
<span class="s2">    </span><span class="se">}}</span>
<span class="s2">  </span><span class="se">}}</span>
<span class="s2">&lt;/style&gt;</span>
<span class="s2">&lt;div style=&quot;max-width:90%; padding:2em;&quot;&gt;</span>
<span class="s2">  &lt;h1&gt;Plots for </span><span class="si">{</span><span class="n">escape</span><span class="p">(</span><span class="n">jobname</span><span class="p">)</span><span class="si">}</span><span class="s2">&lt;/h1&gt;</span>
<span class="s2">  &lt;img src=&quot;</span><span class="si">{</span><span class="n">pae</span><span class="si">}</span><span class="s2">&quot; class=&quot;full&quot; /&gt;</span>
<span class="s2">  &lt;img src=&quot;</span><span class="si">{</span><span class="n">cov</span><span class="si">}</span><span class="s2">&quot; class=&quot;half&quot; /&gt;</span>
<span class="s2">  &lt;img src=&quot;</span><span class="si">{</span><span class="n">plddt</span><span class="si">}</span><span class="s2">&quot; class=&quot;half&quot; /&gt;</span>
<span class="s2">&lt;/div&gt;</span>
<span class="s2">&quot;&quot;&quot;</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#@title Package and download results</span>
<span class="c1">#@markdown If you are having issues downloading the result archive, try disabling your adblocker and run this cell again. If that fails click on the little folder icon to the left, navigate to file: `jobname.result.zip`, right-click and select \&quot;Download\&quot; (see [screenshot](https://pbs.twimg.com/media/E6wRW2lWUAEOuoe?format=jpg&amp;name=small)).</span>

<span class="k">if</span> <span class="n">msa_mode</span> <span class="o">==</span> <span class="s2">&quot;custom&quot;</span><span class="p">:</span>
  <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Don&#39;t forget to cite your custom MSA generation method.&quot;</span><span class="p">)</span>

<span class="n">files</span><span class="o">.</span><span class="n">download</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">jobname</span><span class="si">}</span><span class="s2">.result.zip&quot;</span><span class="p">)</span>

<span class="k">if</span> <span class="n">save_to_google_drive</span> <span class="o">==</span> <span class="kc">True</span> <span class="ow">and</span> <span class="n">drive</span><span class="p">:</span>
  <span class="n">uploaded</span> <span class="o">=</span> <span class="n">drive</span><span class="o">.</span><span class="n">CreateFile</span><span class="p">({</span><span class="s1">&#39;title&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">jobname</span><span class="si">}</span><span class="s2">.result.zip&quot;</span><span class="p">})</span>
  <span class="n">uploaded</span><span class="o">.</span><span class="n">SetContentFile</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">jobname</span><span class="si">}</span><span class="s2">.result.zip&quot;</span><span class="p">)</span>
  <span class="n">uploaded</span><span class="o">.</span><span class="n">Upload</span><span class="p">()</span>
  <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Uploaded </span><span class="si">{</span><span class="n">jobname</span><span class="si">}</span><span class="s2">.result.zip to Google Drive with ID </span><span class="si">{</span><span class="n">uploaded</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="instructions-a-name-instructions-a">
<h1>Instructions <a name="Instructions"></a><a class="headerlink" href="#instructions-a-name-instructions-a" title="Permalink to this heading">#</a></h1>
<p><strong>Quick start</strong></p>
<ol class="arabic simple">
<li><p>Paste your protein sequence(s) in the input field.</p></li>
<li><p>Press “Runtime” -&gt; “Run all”.</p></li>
<li><p>The pipeline consists of 5 steps. The currently running step is indicated by a circle with a stop sign next to it.</p></li>
</ol>
<p><strong>Result zip file contents</strong></p>
<ol class="arabic simple">
<li><p>PDB formatted structures sorted by avg. pLDDT and complexes are sorted by pTMscore. (unrelaxed and relaxed if <code class="docutils literal notranslate"><span class="pre">use_amber</span></code> is enabled).</p></li>
<li><p>Plots of the model quality.</p></li>
<li><p>Plots of the MSA coverage.</p></li>
<li><p>Parameter log file.</p></li>
<li><p>A3M formatted input MSA.</p></li>
<li><p>A <code class="docutils literal notranslate"><span class="pre">predicted_aligned_error_v1.json</span></code> using <a class="reference external" href="https://alphafold.ebi.ac.uk/faq#faq-7">AlphaFold-DB’s format</a> and a <code class="docutils literal notranslate"><span class="pre">scores.json</span></code> for each model which contains an array (list of lists) for PAE, a list with the average pLDDT and the pTMscore.</p></li>
<li><p>BibTeX file with citations for all used tools and databases.</p></li>
</ol>
<p>At the end of the job a download modal box will pop up with a <code class="docutils literal notranslate"><span class="pre">jobname.result.zip</span></code> file. Additionally, if the <code class="docutils literal notranslate"><span class="pre">save_to_google_drive</span></code> option was selected, the <code class="docutils literal notranslate"><span class="pre">jobname.result.zip</span></code> will be uploaded to your Google Drive.</p>
<p><strong>MSA generation for complexes</strong></p>
<p>For the complex prediction we use unpaired and paired MSAs. Unpaired MSA is generated the same way as for the protein structures prediction by searching the UniRef100 and environmental sequences three iterations each.</p>
<p>The paired MSA is generated by searching the UniRef100 database and pairing the best hits sharing the same NCBI taxonomic identifier (=species or sub-species). We only pair sequences if all of the query sequences are present for the respective taxonomic identifier.</p>
<p><strong>Using a custom MSA as input</strong></p>
<p>To predict the structure with a custom MSA (A3M formatted): (1) Change the <code class="docutils literal notranslate"><span class="pre">msa_mode</span></code>: to “custom”, (2) Wait for an upload box to appear at the end of the “MSA options …” box. Upload your A3M. The first fasta entry of the A3M must be the query sequence without gaps.</p>
<p>It is also possilbe to proide custom MSAs for complex predictions. Read more about the format <a class="reference external" href="https://github.com/sokrypton/ColabFold/issues/76">here</a>.</p>
<p>As an alternative for MSA generation the <a class="reference external" href="https://toolkit.tuebingen.mpg.de/tools/hhblits">HHblits Toolkit server</a> can be used. After submitting your query, click “Query Template MSA” -&gt; “Download Full A3M”. Download the A3M file and upload it in this notebook.</p>
<p><strong>PDB100</strong> <a name="pdb100"></a></p>
<p>As of 23/06/08, we have transitioned from using the PDB70 to a 100% clustered PDB, the PDB100. The construction methodology of PDB100 differs from that of PDB70.</p>
<p>The PDB70 was constructed by running each PDB70 representative sequence through <a class="reference external" href="https://github.com/soedinglab/hh-suite">HHblits</a> against the <a class="reference external" href="https://uniclust.mmseqs.com/">Uniclust30</a>. On the other hand, the PDB100 is built by searching each PDB100 representative structure with <a class="reference external" href="https://github.com/steineggerlab/foldseek">Foldseek</a> against the <a class="reference external" href="https://alphafold.ebi.ac.uk">AlphaFold Database</a>.</p>
<p>To maintain compatibility with older Notebook versions and local installations, the generated files and API responses will continue to be named “PDB70”, even though we’re now using the PDB100.</p>
<p><strong>Using custom templates</strong> <a name="custom_templates"></a></p>
<p>To predict the structure with a custom template (PDB or mmCIF formatted): (1) change the <code class="docutils literal notranslate"><span class="pre">template_mode</span></code> to “custom” in the execute cell and (2) wait for an upload box to appear at the end of the “Input Protein” box. Select and upload your templates (multiple choices are possible).</p>
<ul class="simple">
<li><p>Templates must follow the four letter PDB naming with lower case letters.</p></li>
<li><p>Templates in mmCIF format must contain <code class="docutils literal notranslate"><span class="pre">_entity_poly_seq</span></code>. An error is thrown if this field is not present. The field <code class="docutils literal notranslate"><span class="pre">_pdbx_audit_revision_history.revision_date</span></code> is automatically generated if it is not present.</p></li>
<li><p>Templates in PDB format are automatically converted to the mmCIF format. <code class="docutils literal notranslate"><span class="pre">_entity_poly_seq</span></code> and <code class="docutils literal notranslate"><span class="pre">_pdbx_audit_revision_history.revision_date</span></code> are automatically generated.</p></li>
</ul>
<p>If you encounter problems, please report them to this <a class="reference external" href="https://github.com/sokrypton/ColabFold/issues/177">issue</a>.</p>
<p><strong>Comparison to the full AlphaFold2 and AlphaFold2 Colab</strong></p>
<p>This notebook replaces the homology detection and MSA pairing of AlphaFold2 with MMseqs2. For a comparison against the <a class="reference external" href="https://colab.research.google.com/github/deepmind/alphafold/blob/main/notebooks/AlphaFold.ipynb">AlphaFold2 Colab</a> and the full <a class="reference external" href="https://github.com/deepmind/alphafold">AlphaFold2</a> system read our <a class="reference external" href="https://www.nature.com/articles/s41592-022-01488-1">paper</a>.</p>
<p><strong>Troubleshooting</strong></p>
<ul class="simple">
<li><p>Check that the runtime type is set to GPU at “Runtime” -&gt; “Change runtime type”.</p></li>
<li><p>Try to restart the session “Runtime” -&gt; “Factory reset runtime”.</p></li>
<li><p>Check your input sequence.</p></li>
</ul>
<p><strong>Known issues</strong></p>
<ul class="simple">
<li><p>Google Colab assigns different types of GPUs with varying amount of memory. Some might not have enough memory to predict the structure for a long sequence.</p></li>
<li><p>Your browser can block the pop-up for downloading the result file. You can choose the <code class="docutils literal notranslate"><span class="pre">save_to_google_drive</span></code> option to upload to Google Drive instead or manually download the result file: Click on the little folder icon to the left, navigate to file: <code class="docutils literal notranslate"><span class="pre">jobname.result.zip</span></code>, right-click and select “Download” (see <a class="reference external" href="https://pbs.twimg.com/media/E6wRW2lWUAEOuoe?format=jpg&amp;name=small">screenshot</a>).</p></li>
</ul>
<p><strong>Limitations</strong></p>
<ul class="simple">
<li><p>Computing resources: Our MMseqs2 API can handle ~20-50k requests per day.</p></li>
<li><p>MSAs: MMseqs2 is very precise and sensitive but might find less hits compared to HHblits/HMMer searched against BFD or MGnify.</p></li>
<li><p>We recommend to additionally use the full <a class="reference external" href="https://github.com/deepmind/alphafold">AlphaFold2 pipeline</a>.</p></li>
</ul>
<p><strong>Description of the plots</strong></p>
<ul class="simple">
<li><p><strong>Number of sequences per position</strong> - We want to see at least 30 sequences per position, for best performance, ideally 100 sequences.</p></li>
<li><p><strong>Predicted lDDT per position</strong> - model confidence (out of 100) at each position. The higher the better.</p></li>
<li><p><strong>Predicted Alignment Error</strong> - For homooligomers, this could be a useful metric to assess how confident the model is about the interface. The lower the better.</p></li>
</ul>
<p><strong>Bugs</strong></p>
<ul class="simple">
<li><p>If you encounter any bugs, please report the issue to <a class="github reference external" href="https://github.com/sokrypton/ColabFold/issues">sokrypton/ColabFold#issues</a></p></li>
</ul>
<p><strong>License</strong></p>
<p>The source code of ColabFold is licensed under <a class="reference external" href="https://raw.githubusercontent.com/sokrypton/ColabFold/main/LICENSE">MIT</a>. Additionally, this notebook uses the AlphaFold2 source code and its parameters licensed under <a class="reference external" href="https://raw.githubusercontent.com/deepmind/alphafold/main/LICENSE">Apache 2.0</a> and <a class="reference external" href="https://creativecommons.org/licenses/by-sa/4.0/">CC BY 4.0</a> respectively. Read more about the AlphaFold license <a class="reference external" href="https://github.com/deepmind/alphafold">here</a>.</p>
<p><strong>Acknowledgments</strong></p>
<ul class="simple">
<li><p>We thank the AlphaFold team for developing an excellent model and open sourcing the software.</p></li>
<li><p><a class="reference external" href="https://kobic.re.kr">KOBIC</a> and <a class="reference external" href="https://www.mpinat.mpg.de/soeding">Söding Lab</a> for providing the computational resources for the MMseqs2 MSA server.</p></li>
<li><p>Richard Evans for helping to benchmark the ColabFold’s Alphafold-multimer support.</p></li>
<li><p><a class="reference external" href="https://github.com/dkoes">David Koes</a> for his awesome <a class="reference external" href="https://3dmol.csb.pitt.edu/">py3Dmol</a> plugin, without whom these notebooks would be quite boring!</p></li>
<li><p>Do-Yoon Kim for creating the ColabFold logo.</p></li>
<li><p>A colab by Sergey Ovchinnikov (<a class="reference external" href="https://twitter.com/sokrypton">&#64;sokrypton</a>), Milot Mirdita (<a class="reference external" href="https://twitter.com/milot_mirdita">&#64;milot_mirdita</a>) and Martin Steinegger (<a class="reference external" href="https://twitter.com/thesteinegger">&#64;thesteinegger</a>).</p></li>
</ul>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./ColabFold"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
                <footer class="bd-footer-article">
                  
<div class="footer-article-items footer-article__inner">
  
    <div class="footer-article-item"><!-- Previous / next buttons -->
<div class="prev-next-area">
    <a class="left-prev"
       href="../index.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Tutorials</p>
      </div>
    </a>
</div></div>
  
</div>

                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">

  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#">News</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#instructions-a-name-instructions-a">Instructions <a name="Instructions"></a></a></li>
</ul>

  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By CCATS Group
</p>

  </div>
  
  <div class="footer-item">
    
  <p class="copyright">
    
      © Copyright 2023.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../_static/scripts/bootstrap.js?digest=e353d410970836974a52"></script>
<script src="../_static/scripts/pydata-sphinx-theme.js?digest=e353d410970836974a52"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>